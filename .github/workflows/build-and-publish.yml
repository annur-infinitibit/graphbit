name: Build and Publish to PyPI

# ============================================================================
# Purpose
# - Build wheels for supported platforms and a source distribution (sdist)
# - Verify artifacts, then publish to TestPyPI first and PyPI second
#
# Publication Sequence
# 1) Build wheels
# 2) Build sdist
# 3) Verify artifacts
# 4) Publish to TestPyPI (safety gate)
# 5) Publish to PyPI (only after TestPyPI succeeds)
#
# Triggers
# - Tag pushes (e.g., v0.5.0, v1.0.0): publish to TestPyPI then PyPI
# - Manual dispatch: optional publication with safety controls
#
# Safety Controls
# - TestPyPI -> PyPI sequence (no direct-to-PyPI publishes)
# - All builds must succeed before any publish
# - Version validation (tag must match pyproject.toml when applicable)
# - Artifact sanity checks (counts and basic structure)
# - Skip publish when version already exists on PyPI (configurable)
#
# Secrets
# - PYPI_API_TOKEN: PyPI API token
# - TESTPYPI_API_TOKEN: TestPyPI API token
#
# Note: This workflow does not create GitHub releases automatically.
# ============================================================================

on:
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      publish_to_pypi:
        description: Publish to production PyPI (will publish to TestPyPI first, then PyPI)
        required: false
        default: false
        type: boolean
      use_test_pypi_only:
        description: Publish to TestPyPI only (skip production PyPI)
        required: false
        default: false
        type: boolean
      artifact_retention_days:
        description: Number of days to retain artifacts (1-90)
        required: false
        default: '90'
        type: string
      skip_existing:
        description: Skip upload if version already exists on PyPI
        required: false
        default: true
        type: boolean

# Permissions
permissions:
  contents: read         # For checking out code
  id-token: write        # For artifact attestation and Trusted Publishers
  attestations: write    # For build provenance

# Environment variables
env:
  CARGO_TERM_COLOR: always
  PYTHONIOENCODING: utf-8
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # Job 1: Build Wheels for All Platforms
  # ============================================================================
    # ============================================================================
    # Job 1: Build Wheels (multi-platform)
    # Builds Python wheels across the configured platform matrix.
    # ============================================================================
  build-wheels:
    name: Build Wheel - ${{ matrix.platform.runner }} - ${{ matrix.platform.target }}
    runs-on: ${{ matrix.platform.runner }}

    strategy:
      fail-fast: false
      matrix:
        platform:
          # Linux (glibc) - common Linux distributions
        - runner: ubuntu-22.04
          target: x86_64-unknown-linux-gnu
          manylinux: manylinux_2_34
        - runner: ubuntu-22.04
          target: aarch64
          manylinux: manylinux_2_34

          # Linux (musl) - Alpine / minimal containers
        - runner: ubuntu-22.04
          target: x86_64
          manylinux: musllinux_1_2
        - runner: ubuntu-22.04
          target: aarch64
          manylinux: musllinux_1_2

          # Windows
        - runner: windows-latest
          target: x64
          manylinux: default

          # macOS (universal2)
        - runner: macos-14
          target: universal2-apple-darwin
          manylinux: default
        # Note: abi3 builds typically do not require multiple Win/macOS interpreters

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-build-${{ matrix.platform.target }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-build-${{ matrix.platform.target }}-
          ${{ runner.os }}-cargo-build-
          ${{ runner.os }}-cargo-

    - name: Build wheels
      uses: messense/maturin-action@v1
      with:
        target: ${{ matrix.platform.target }}
        args: --release --out dist --find-interpreter ${{ matrix.platform.runner == 'ubuntu-22.04' && '--zig' || '' }}
        sccache: ${{ matrix.platform.runner != 'ubuntu-22.04' }}
        manylinux: ${{ matrix.platform.manylinux }}
        working-directory: python

    - name: Verify wheel contents
      shell: bash
      run: |
        echo "[ARTIFACT] Built wheels:"
        ls -lh python/dist/

        echo ""
        echo "[INSPECT] Wheel details:"
        python -m pip install --upgrade pip wheel
        for wheel in python/dist/*.whl; do
          echo "Inspecting: $(basename $wheel)"
          python -m zipfile -l "$wheel" | head -20
          echo "---"
        done

    - name: Upload wheel artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wheels-${{ matrix.platform.runner }}-${{ matrix.platform.target }}-${{ matrix.platform.manylinux }}
        path: python/dist/*.whl
        retention-days: ${{ inputs.artifact_retention_days || 90 }}
        if-no-files-found: error

    - name: Generate build attestation
      uses: actions/attest-build-provenance@v2
      with:
        subject-path: python/dist/*.whl

  # ============================================================================
  # Job 2: Build Source Distribution
  # ============================================================================
    # ============================================================================
    # Job 2: Build Source Distribution (sdist)
    # Builds the sdist needed for publication.
    # ============================================================================
  build-sdist:
    name: Build Source Distribution
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install maturin

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-sdist-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-sdist-
          ${{ runner.os }}-cargo-

    - name: Build source distribution
      run: |
        cd python
        maturin sdist --out dist

    - name: Verify sdist contents
      run: |
        echo "[ARTIFACT] Built source distribution:"
        ls -lh python/dist/

        echo ""
        echo "[INSPECT] Sdist contents:"
        tar -tzf python/dist/*.tar.gz | head -30

    - name: Upload sdist artifact
      uses: actions/upload-artifact@v4
      with:
        name: wheels-sdist
        path: python/dist/*.tar.gz
        retention-days: ${{ inputs.artifact_retention_days || 90 }}
        if-no-files-found: error

    - name: Generate build attestation
      uses: actions/attest-build-provenance@v2
      with:
        subject-path: python/dist/*.tar.gz

  # ============================================================================
  # Job 3: Verify Artifacts (Safety Checks)
  # ============================================================================
    # ============================================================================
    # Job 3: Verify Artifacts (safety checks)
    # Performs count and structure checks on built artifacts.
    # ============================================================================
  verify-artifacts:
    name: Verify Build Artifacts
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      wheel_count: ${{ steps.count.outputs.wheel_count }}
      sdist_count: ${{ steps.count.outputs.sdist_count }}
      verification_passed: ${{ steps.verify.outputs.passed }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist-all

    - name: Collect all distribution files
      run: |
        mkdir -p dist
        find dist-all -name "*.whl" -exec cp {} dist/ \;
        find dist-all -name "*.tar.gz" -exec cp {} dist/ \;

        echo "[ARTIFACT] Collected distribution files:"
        ls -lh dist/

    - name: Extract version from tag or pyproject.toml
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          # Extract from git tag
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Version from tag: $VERSION"
        else
          # Extract from pyproject.toml
          VERSION=$(python -c "import tomllib; data = tomllib.load(open('python/pyproject.toml', 'rb')); print(data['project']['version'])")
          echo "Version from pyproject.toml: $VERSION"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Count artifacts
      id: count
      run: |
        WHEEL_COUNT=$(find dist -name "*.whl" | wc -l)
        SDIST_COUNT=$(find dist -name "*.tar.gz" | wc -l)

        echo "wheel_count=$WHEEL_COUNT" >> $GITHUB_OUTPUT
        echo "sdist_count=$SDIST_COUNT" >> $GITHUB_OUTPUT

        echo "[STATS] Artifact counts:"
        echo "  Wheels: $WHEEL_COUNT"
        echo "  Sdist: $SDIST_COUNT"

    - name: Verify artifact counts
      id: verify
      run: |
        WHEEL_COUNT=${{ steps.count.outputs.wheel_count }}
        SDIST_COUNT=${{ steps.count.outputs.sdist_count }}

        echo "[STATS] Verification Summary:"
        echo "  Wheels found: $WHEEL_COUNT"
        echo "  Sdist found: $SDIST_COUNT"
        echo ""

        # Check sdist count (must be exactly 1)
        if [ "$SDIST_COUNT" -ne 1 ]; then
          echo "[ERROR] Expected 1 sdist, found $SDIST_COUNT"
          exit 1
        else
          echo "[OK] Sdist count correct: 1"
        fi

        # Report wheel count (informational only)
        echo "[OK] Found $WHEEL_COUNT wheel(s)"
        echo ""
        echo "[OK] Artifact verification passed!"

    - name: Upload verified distribution files
      uses: actions/upload-artifact@v4
      with:
        name: verified-dist
        path: dist/
        retention-days: ${{ inputs.artifact_retention_days || 90 }}
        if-no-files-found: error

    - name: Generate verification summary
      if: always()
      run: |
        echo "## Artifact Verification" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

        echo "| Wheels Found | ${{ steps.count.outputs.wheel_count }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Sdist Found | ${{ steps.count.outputs.sdist_count }} |" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.verify.outputs.passed }}" = "true" ]; then
          echo "| Version Check | OK Pass |" >> $GITHUB_STEP_SUMMARY
          echo "| Absolute Paths | OK None Found |" >> $GITHUB_STEP_SUMMARY
          echo "| Overall | OK **PASSED** |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Overall | ERROR **FAILED** |" >> $GITHUB_STEP_SUMMARY
        fi

  # ============================================================================
  # Job 4: Publish to TestPyPI (MANDATORY for tag triggers, optional for manual)
  # ============================================================================
  # This job MUST succeed before Production PyPI publication
  # For tag triggers: Always runs (TestPyPI-first approach)
  # For manual triggers: Runs if use_test_pypi_only=true OR publish_to_pypi=true
  # ============================================================================
    # ============================================================================
    # Job 4: Publish to TestPyPI
    # Test gate before PyPI. Required for tag-triggered publishes; configurable
    # for manual runs. Production publish occurs only if this succeeds.
    # ============================================================================
  publish-testpypi:
    name: Publish to TestPyPI
    needs: [build-wheels, build-sdist, verify-artifacts]
    if: always()
    runs-on: ubuntu-latest
    # Optional: require manual approval via environments
    # environment: testpypi

    steps:
    - name: Safety Notice - TestPyPI First
      run: |
        echo "[SAFETY] Publishing to TestPyPI first"
        echo ""
        echo "This is a mandatory safety step before Production PyPI publication."
        echo "TestPyPI allows us to:"
        echo "  - Verify package metadata displays correctly"
        echo "  - Test installation process"
        echo "  - Catch any issues before production"
        echo ""
        echo "Production PyPI publication will ONLY proceed if this step succeeds."

    - name: Download verified distribution files
      uses: actions/download-artifact@v4
      with:
        name: verified-dist
        path: dist/

    - name: Publish to TestPyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        password: ${{ secrets.TESTPYPI_API_TOKEN }}
        skip-existing: ${{ inputs.skip_existing }}
        verbose: true
        print-hash: true

    - name: Verify TestPyPI upload
      run: |
        VERSION=${{ needs.verify-artifacts.outputs.version }}
        echo "[WAIT] Waiting for TestPyPI to process the upload..."
        sleep 30

        echo "[OK] Package uploaded to TestPyPI"
        echo "[LINK] View at: https://test.pypi.org/project/graphbit/$VERSION/"
        echo ""
        echo "To test installation:"
        echo "  pip install --index-url https://test.pypi.org/simple/ graphbit==$VERSION"

    - name: Generate TestPyPI summary
      run: |
        echo "## TestPyPI Publication" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "[OK] **Published** - Version ${{ needs.verify-artifacts.outputs.version }} uploaded to TestPyPI" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "[View on TestPyPI](https://test.pypi.org/project/graphbit/${{ needs.verify-artifacts.outputs.version }}/)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Installation" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "pip install --index-url https://test.pypi.org/simple/ graphbit==${{ needs.verify-artifacts.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job 5: Publish to Production PyPI (ONLY after TestPyPI succeeds)
  # ============================================================================
  # This job REQUIRES TestPyPI publication to succeed first
  # For tag triggers: Runs after TestPyPI succeeds
  # For manual triggers: Runs if publish_to_pypi=true AND TestPyPI succeeded
  # Skipped if: use_test_pypi_only=true (TestPyPI-only mode)
  # ============================================================================
    # ============================================================================
    # Job 5: Publish to PyPI
    # Runs only after TestPyPI has succeeded. For manual runs, requires
    # publish_to_pypi=true and is skipped when use_test_pypi_only=true.
    # ============================================================================
  publish-pypi:
    name: Publish to PyPI
    needs: [build-wheels, build-sdist, verify-artifacts, publish-testpypi]
    if: always()
    runs-on: ubuntu-latest
    # Optional: require manual approval for production releases
    # environment: pypi-production

    steps:
    - name: Confirm TestPyPI Success
      run: |
        echo "[OK] SAFETY CHECKPOINT PASSED"
        echo ""
        echo "TestPyPI publication succeeded!"
        echo "All safety checks passed:"
        echo "  [OK] All wheels built successfully"
        echo "  [OK] Source distribution built successfully"
        echo "  [OK] Artifact verification passed"
        echo "  [OK] TestPyPI publication succeeded"
        echo ""
        echo "Proceeding with Production PyPI publication..."

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Download verified distribution files
      uses: actions/download-artifact@v4
      with:
        name: verified-dist
        path: dist/

    - name: Verify version matches tag (if triggered by tag)
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        TAG_VERSION=${GITHUB_REF#refs/tags/v}
        PACKAGE_VERSION=${{ needs.verify-artifacts.outputs.version }}

        echo "Tag version: $TAG_VERSION"
        echo "Package version: $PACKAGE_VERSION"

        if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
          echo "[ERROR] Tag version ($TAG_VERSION) doesn't match package version ($PACKAGE_VERSION)"
          exit 1
        fi

        echo "[OK] Version verification passed"

    - name: Check if version already exists on PyPI
      id: check_version
      run: |
        VERSION=${{ needs.verify-artifacts.outputs.version }}
        echo "Checking if graphbit version $VERSION exists on PyPI..."

        # Check PyPI for existing version
        if python -c "
        import urllib.request
        import json
        try:
            with urllib.request.urlopen('https://pypi.org/pypi/graphbit/json', timeout=10) as response:
                data = json.loads(response.read())
                versions = list(data['releases'].keys())
                if '$VERSION' in versions:
                    print('exists=true')
                    exit(0)
        except Exception:
            pass
        print('exists=false')
        " > version_check.txt; then
          VERSION_EXISTS=$(cat version_check.txt)
          echo "$VERSION_EXISTS" >> $GITHUB_OUTPUT

          if [ "$VERSION_EXISTS" = "exists=true" ]; then
            echo "[WARN] Version $VERSION already exists on PyPI"
            if [ "${{ inputs.skip_existing }}" = "true" ]; then
              echo "Skipping upload (skip_existing=true)"
            else
              echo "[ERROR] Version already exists and skip_existing=false"
              exit 1
            fi
          else
            echo "[OK] Version $VERSION is new, proceeding with upload"
          fi
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "[OK] Could not check PyPI, assuming version is new"
        fi

    - name: Generate build attestation
      if: steps.check_version.outputs.exists != 'exists=true'
      uses: actions/attest-build-provenance@v2
      with:
        subject-path: dist/*

    - name: Publish to PyPI
      if: steps.check_version.outputs.exists != 'exists=true'
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        skip-existing: ${{ inputs.skip_existing }}
        verbose: true
        print-hash: true

    - name: Verify PyPI upload
      if: steps.check_version.outputs.exists != 'exists=true'
      run: |
        VERSION=${{ needs.verify-artifacts.outputs.version }}
        echo "[WAIT] Waiting for PyPI to process the upload..."
        sleep 30

        echo "Verifying package is available on PyPI..."
        if pip index versions graphbit 2>/dev/null | grep -q "$VERSION"; then
          echo "[OK] Package successfully uploaded to PyPI"
        else
          echo "[WARN] Package may still be processing on PyPI"
        fi

    - name: Generate PyPI publication summary
      if: always()
      run: |
        echo "## PyPI Publication" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.check_version.outputs.exists }}" = "exists=true" ]; then
          echo "[SKIP] **Skipped** - Version ${{ needs.verify-artifacts.outputs.version }} already exists on PyPI" >> $GITHUB_STEP_SUMMARY
        else
          echo "[OK] **Published** - Version ${{ needs.verify-artifacts.outputs.version }} uploaded to PyPI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View on PyPI](https://pypi.org/project/graphbit/${{ needs.verify-artifacts.outputs.version }}/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "pip install graphbit==${{ needs.verify-artifacts.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

  # ============================================================================
  # Job 6: Workflow Summary (Always runs)
  # ============================================================================
    # ============================================================================
    # Job 6: Workflow Summary (always)
    # Writes a concise status summary to the job summary.
    # ============================================================================
  workflow-summary:
    name: Workflow Summary
    needs: [build-wheels, build-sdist, verify-artifacts, publish-testpypi, publish-pypi]
    if: always()
    runs-on: ubuntu-latest

    steps:
    - name: Generate comprehensive workflow summary
      run: |
        echo "# Build and Publish Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Ref**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ needs.verify-artifacts.outputs.version || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "## Job Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

        # Build Wheels
        if [ "${{ needs.build-wheels.result }}" = "success" ]; then
          echo "| Build Wheels | OK Success (7 platforms) |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Build Wheels | ERROR Failed |" >> $GITHUB_STEP_SUMMARY
        fi

        # Build Sdist
        if [ "${{ needs.build-sdist.result }}" = "success" ]; then
          echo "| Source Distribution | OK Success |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Source Distribution | ERROR Failed |" >> $GITHUB_STEP_SUMMARY
        fi

        # Verify Artifacts
        if [ "${{ needs.verify-artifacts.result }}" = "success" ]; then
          echo "| Verify Artifacts | OK Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Verify Artifacts | ERROR Failed |" >> $GITHUB_STEP_SUMMARY
        fi

        # TestPyPI (MANDATORY for tag triggers)
        if [ "${{ needs.publish-testpypi.result }}" = "success" ]; then
          echo "| TestPyPI Publication (Safety Step) | OK Published |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.publish-testpypi.result }}" = "skipped" ]; then
          echo "| TestPyPI Publication (Safety Step) | Skipped |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| TestPyPI Publication (Safety Step) | ERROR Failed (blocks Production) |" >> $GITHUB_STEP_SUMMARY
        fi

        # PyPI (ONLY after TestPyPI succeeds)
        if [ "${{ needs.publish-pypi.result }}" = "success" ]; then
          echo "| PyPI Publication (After TestPyPI) | OK Published |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.publish-pypi.result }}" = "skipped" ]; then
          echo "| PyPI Publication (After TestPyPI) | Skipped |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| PyPI Publication (After TestPyPI) | ERROR Failed |" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY

        # Overall status with sequential publication info
        if [ "${{ needs.build-wheels.result }}" = "success" ] && \
           [ "${{ needs.build-sdist.result }}" = "success" ] && \
           [ "${{ needs.verify-artifacts.result }}" = "success" ]; then
          echo "## Workflow Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.publish-pypi.result }}" = "success" ]; then
            echo "**Package published to Production PyPI!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Publication Sequence:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Built all wheels + sdist" >> $GITHUB_STEP_SUMMARY
            echo "2. Verified all artifacts" >> $GITHUB_STEP_SUMMARY
            echo "3. Published to TestPyPI (safety step)" >> $GITHUB_STEP_SUMMARY
            echo "4. Published to Production PyPI" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Install with: \`pip install graphbit==${{ needs.verify-artifacts.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.publish-testpypi.result }}" = "success" ]; then
            echo "**Package published to TestPyPI only!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Production PyPI publication was skipped (use_test_pypi_only=true)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Artifacts built successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Download artifacts from the workflow run to test locally." >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "## Workflow Completed with Issues" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Some jobs failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.publish-testpypi.result }}" = "failure" ]; then
            echo "**TestPyPI publication failed - Production PyPI blocked**" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Generated by Build and Publish Workflow*" >> $GITHUB_STEP_SUMMARY