name: Build Distribution Artifacts

# ============================================================================
# Purpose
# - Build wheels for supported platforms and a source distribution (sdist)
# - Verify artifacts to ensure builds are working correctly
# - Does NOT publish to PyPI or TestPyPI
#
# Use this workflow to test if the project builds accurately without publishing
# ============================================================================

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      artifact_retention_days:
        description: Number of days to retain artifacts (1-90)
        required: false
        default: '7'
        type: string


# Permissions
permissions:
  contents: read         # For checking out code
  id-token: write        # For artifact attestation
  attestations: write    # For build provenance

# Environment variables
env:
  CARGO_TERM_COLOR: always
  PYTHONIOENCODING: utf-8
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # Job 1: Build Wheels for All Platforms
  # ============================================================================
  build-wheels:
    name: Build Wheel - ${{ matrix.platform.runner }} - ${{ matrix.platform.target }}
    runs-on: ${{ matrix.platform.runner }}

    strategy:
      fail-fast: false
      matrix:
        platform:
          # Linux (glibc) - common Linux distributions
        - runner: ubuntu-22.04
          target: x86_64
          manylinux: manylinux_2_34
        - runner: ubuntu-22.04
          target: aarch64
          manylinux: manylinux_2_34

          # Linux (musl) - Alpine / minimal containers
        - runner: ubuntu-22.04
          target: x86_64
          manylinux: musllinux_1_2
        - runner: ubuntu-22.04
          target: aarch64
          manylinux: musllinux_1_2

          # Windows
        - runner: windows-latest
          target: x64
          manylinux: default

          # macOS (universal2)
        - runner: macos-14
          target: universal2-apple-darwin
          manylinux: default

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-build-${{ matrix.platform.target }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-build-${{ matrix.platform.target }}-
          ${{ runner.os }}-cargo-build-
          ${{ runner.os }}-cargo-

    - name: Build wheels
      uses: messense/maturin-action@v1
      with:
        target: ${{ matrix.platform.target }}
        args: --release --out dist --find-interpreter ${{ matrix.platform.runner == 'ubuntu-22.04' && '--zig' || '' }}
        sccache: ${{ matrix.platform.runner != 'ubuntu-22.04' }}
        manylinux: ${{ matrix.platform.manylinux }}
        working-directory: python
        

    - name: Verify wheel contents
      shell: bash
      run: |
        echo "[ARTIFACT] Built wheels:"
        ls -lh python/dist/

        echo ""
        echo "[INSPECT] Wheel details:"
        python -m pip install --upgrade pip wheel
        for wheel in python/dist/*.whl; do
          echo "Inspecting: $(basename $wheel)"
          python -m zipfile -l "$wheel" | head -20
          echo "---"
        done

    - name: Upload wheel artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wheels-${{ matrix.platform.runner }}-${{ matrix.platform.target }}-${{ matrix.platform.manylinux }}
        path: python/dist/*.whl
        retention-days: ${{ inputs.artifact_retention_days || 30 }}
        if-no-files-found: error

    - name: Generate build attestation
      uses: actions/attest-build-provenance@v2
      with:
        subject-path: python/dist/*.whl

  # ============================================================================
  # Job 2: Build Source Distribution
  # ============================================================================
  build-sdist:
    name: Build Source Distribution
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install maturin

    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-sdist-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-sdist-
          ${{ runner.os }}-cargo-

    - name: Build source distribution
      run: |
        cd python
        maturin sdist --out dist

    - name: Verify sdist contents
      run: |
        echo "[ARTIFACT] Built source distribution:"
        ls -lh python/dist/

        echo ""
        echo "[INSPECT] Sdist contents:"
        tar -tzf python/dist/*.tar.gz | head -30

    - name: Upload sdist artifact
      uses: actions/upload-artifact@v4
      with:
        name: wheels-sdist
        path: python/dist/*.tar.gz
        retention-days: ${{ inputs.artifact_retention_days || 30 }}
        if-no-files-found: error

    - name: Generate build attestation
      uses: actions/attest-build-provenance@v2
      with:
        subject-path: python/dist/*.tar.gz

  # ============================================================================
  # Job 3: Verify Artifacts (Safety Checks)
  # ============================================================================
  verify-artifacts:
    name: Verify Build Artifacts
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      wheel_count: ${{ steps.count.outputs.wheel_count }}
      sdist_count: ${{ steps.count.outputs.sdist_count }}
      verification_passed: ${{ steps.verify.outputs.passed }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist-all

    - name: Collect all distribution files
      run: |
        mkdir -p dist
        find dist-all -name "*.whl" -exec cp {} dist/ \;
        find dist-all -name "*.tar.gz" -exec cp {} dist/ \;

        echo "[ARTIFACT] Collected distribution files:"
        ls -lh dist/

    - name: Extract version from pyproject.toml
      id: version
      run: |
        # Extract from pyproject.toml
        VERSION=$(python -c "import tomllib; data = tomllib.load(open('python/pyproject.toml', 'rb')); print(data['project']['version'])")
        echo "Version from pyproject.toml: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Count artifacts
      id: count
      run: |
        WHEEL_COUNT=$(find dist -name "*.whl" | wc -l)
        SDIST_COUNT=$(find dist -name "*.tar.gz" | wc -l)

        echo "wheel_count=$WHEEL_COUNT" >> $GITHUB_OUTPUT
        echo "sdist_count=$SDIST_COUNT" >> $GITHUB_OUTPUT

        echo "[STATS] Artifact counts:"
        echo "  Wheels: $WHEEL_COUNT"
        echo "  Sdist: $SDIST_COUNT"

    - name: Verify artifact counts
      id: verify
      run: |
        WHEEL_COUNT=${{ steps.count.outputs.wheel_count }}
        SDIST_COUNT=${{ steps.count.outputs.sdist_count }}

        echo "[STATS] Verification Summary:"
        echo "  Wheels found: $WHEEL_COUNT"
        echo "  Sdist found: $SDIST_COUNT"
        echo ""

        # Check sdist count (must be exactly 1)
        if [ "$SDIST_COUNT" -ne 1 ]; then
          echo "[ERROR] Expected 1 sdist, found $SDIST_COUNT"
          exit 1
        else
          echo "[OK] Sdist count correct: 1"
        fi

        # Report wheel count (informational only)
        echo "[OK] Found $WHEEL_COUNT wheel(s)"
        echo ""
        echo "[OK] Artifact verification passed!"
        echo "passed=true" >> $GITHUB_OUTPUT

    - name: Upload verified distribution files
      uses: actions/upload-artifact@v4
      with:
        name: verified-dist
        path: dist/
        retention-days: ${{ inputs.artifact_retention_days || 30 }}
        if-no-files-found: error

    - name: Generate verification summary
      if: always()
      run: |
        echo "## Artifact Verification" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

        echo "| Wheels Found | ${{ steps.count.outputs.wheel_count }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Sdist Found | ${{ steps.count.outputs.sdist_count }} |" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.verify.outputs.passed }}" = "true" ]; then
          echo "| Overall | ✅ **PASSED** |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Overall | ❌ **FAILED** |" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "**Note**: This is a test build workflow. No packages were published to PyPI." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job 4: Build Summary
  # ============================================================================
  build-summary:
    name: Build Summary
    needs: [build-wheels, build-sdist, verify-artifacts]
    if: always()
    runs-on: ubuntu-latest

    steps:
    - name: Generate comprehensive build summary
      run: |
        echo "# Test Build Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Ref**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Version**: ${{ needs.verify-artifacts.outputs.version || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "## Job Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

        # Build Wheels
        if [ "${{ needs.build-wheels.result }}" = "success" ]; then
          echo "| Build Wheels | ✅ Success (7 platforms) |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Build Wheels | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
        fi

        # Build Sdist
        if [ "${{ needs.build-sdist.result }}" = "success" ]; then
          echo "| Source Distribution | ✅ Success |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Source Distribution | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
        fi

        # Verify Artifacts
        if [ "${{ needs.verify-artifacts.result }}" = "success" ]; then
          echo "| Verify Artifacts | ✅ Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Verify Artifacts | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY

        # Overall status
        if [ "${{ needs.build-wheels.result }}" = "success" ] && \
           [ "${{ needs.build-sdist.result }}" = "success" ] && \
           [ "${{ needs.verify-artifacts.result }}" = "success" ]; then
          echo "## ✅ All Builds Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All wheels and source distribution built successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- Wheels: ${{ needs.verify-artifacts.outputs.wheel_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Sdist: ${{ needs.verify-artifacts.outputs.sdist_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download artifacts from the workflow run to test locally." >> $GITHUB_STEP_SUMMARY
        else
          echo "## ❌ Build Issues Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Some jobs failed. Please review the logs above." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*This workflow only tests builds - no packages are published to PyPI*" >> $GITHUB_STEP_SUMMARY
